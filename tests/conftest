import pytest
import requests
import yaml
import os
from selenium import webdriver
from datetime import datetime
from utils.driver_factory import get_driver
from utils.logger import get_logger

logger = get_logger()



# Fixture de configuración

@pytest.fixture(scope="session")
def config():
    with open("config/config.yaml") as f:
        cfg = yaml.safe_load(f)
    logger.info("Configuración cargada correctamente")
    return cfg



# Fixture de WebDriver (UI)

@pytest.fixture
def driver(config):
    browser = config.get("browser", "chrome").lower()
    if browser == "chrome":
        options = webdriver.ChromeOptions()
        options.add_argument("--start-maximized")
        driver = webdriver.Chrome(options=options)
    elif browser == "firefox":
        driver = webdriver.Firefox()
        driver.maximize_window()
    else:
        raise ValueError(f"Browser {browser} no soportado")

    driver.implicitly_wait(config.get("implicit_wait", 5))
    logger.info(f"{browser.capitalize()} WebDriver iniciado")
    yield driver
    driver.quit()
    logger.info(f"{browser.capitalize()} WebDriver cerrado")



# Hook para screenshots en fallos (UI)

def pytest_configure(config):
    global pytest_html
    pytest_html = config.pluginmanager.getplugin('html')

@pytest.hookimpl(hookwrapper=True)
def pytest_runtest_makereport(item, call):
    """Captura screenshot en caso de fallo y lo añade al reporte HTML"""
    outcome = yield
    rep = outcome.get_result()

    if rep.when == "call" and rep.failed:
        driver = item.funcargs.get("driver")
        if driver:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            screenshot_name = f"{item.name}_{timestamp}.png"
            screenshot_dir = os.path.join("reports", "screenshots")
            os.makedirs(screenshot_dir, exist_ok=True)
            screenshot_path = os.path.join(screenshot_dir, screenshot_name)
            driver.save_screenshot(screenshot_path)
            logger.error(f"Test falló, screenshot guardado en {screenshot_path}")

            # Añadir imagen al reporte HTML
            extra = getattr(rep, 'extra', [])
            extra.append(pytest_html.extras.image(screenshot_path))
            rep.extra = extra



# Fixture de Requests (API)

@pytest.fixture
def session():
    with requests.Session() as s:
        yield s



# Logging adicional por test

@pytest.hookimpl(tryfirst=True)
def pytest_runtest_setup(item):
    logger.info(f"Iniciando test: {item.name}")

@pytest.hookimpl(tryfirst=True)
def pytest_runtest_teardown(item, nextitem):
    logger.info(f"Finalizado test: {item.name}")
